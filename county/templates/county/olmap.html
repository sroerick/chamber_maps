{% load static %}

<!doctype html>
<html lang="en">
<head>
  <script type="text/javascript">
    var mapName = "{{mapname}}";
    var mapDesc = "{{mapdescription}}";
    var mapControl = "{{mapcontrol}}";
    var mapDeclutterTemplate = "{{mapdeclutter}}";
    let mapDeclutter = (mapDeclutterTemplate == "True")
  </script>
  <title>{{mapname}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" type="text/css" href="{% static 'gis/css/olmap.css' %}">
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.12.0/build/ol.js"></script>

<style>


.map {
      height: 700px;
      width: 100%;
          }
	  
</style>
<body>
	<div id="topbar" class="topbar">hello</div>
	<div id="sidebar" class="sidebar">Sidebar</div>
	<div id="map" class="map"></div>
	<a id="export-png" class="btn btn-default"><i class="fa fa-download"></i> Download PNG</a>
	    <a id="image-download" download="map.png"></a>
  <script type="text/javascript">
	  /*
    async function load_counties() {
        const pathArray = window.location.pathname.split('/')
        const slug = pathArray.at(-2)
	    const counties_url = `/api/map/` + slug + '/'
	    const response = await fetch(counties_url)
	    const json = await response.json()
	    return(json)
    }*/


	const parsed = JSON.parse(mapControl.replaceAll('&quot','"').replaceAll(';',''))
	const upper_limit_array = [0]
	const upper_limit_sort = function () {
		for (i=0; i < parsed.length; i++) {
				upper_limit_array.push(parsed[i].fields.upper_limit)
				}
}
    function getColorLive(d) {
      for (i=0; i < parsed.length; i++) {
	  if (d >=parsed[i].fields.lower_limit && d <=parsed[i].fields.upper_limit)
	    return parsed[i].fields.color
		        }
    }



    function render_counties() {
        const pathArray = window.location.pathname.split('/')
        const slug = pathArray.at(-2)
        const counties_url = `/api/map/` + slug + '/'
	//const counties = await load_counties()
	const shapeSource = new ol.source.Vector({
		ratio: 1, 
		params: {'LAYERS': 'show:0'},
		url: counties_url,
		format: new ol.format.GeoJSON()
	})
	const shapeLayer = new ol.layer.Vector({
		source: shapeSource,
		style: styleFunction,
		declutter: mapDeclutter
	});
	    map.addLayer(shapeLayer);
    }
	  var map = new ol.Map({
		      target: 'map',
		      controls: ol.control.defaults({ attribution: false }),
		      layers: [
			            new ol.layer.Tile({
					            source: new ol.source.OSM()
					          })
			          ],
		      view: new ol.View({
			            center: ol.proj.fromLonLat([-89.29, 40.63]),
			            zoom: 6
			          })
		    });
/*
    styleFunction = function(feature) {
	    let colors = ['red', 'blue', 'green', 'pink']
	      let stroke = new ol.style.Stroke({ color: 'yellow', width: 1 });
	      let randomIndex = Math.floor( Math.random() * 9 );
	      let fill = new ol.style.Fill({ color: colors[randomIndex] });
	      let style = new ol.style.Style({ stroke: stroke, fill: fill }); 
	    return style;
    }*/
    styleFunction = function(feature) {
	      let countyname= feature.A.countyname 
	      let floatvalue = feature.A.floatdata
	      let offsetx = feature.A.offsetx
	      let offsety = feature.A.offsety
	      let description = countyname + "\n" + floatvalue
	      let text = new ol.style.Text({
	 	 text: description, 
	  	 font:'9px sans-serif', 
	         overflow:true,  
	  	 offsetX: offsetx, 
	         offsetY:offsety })
	      let stroke = new ol.style.Stroke({ color: 'yellow', width: 1 });
	      let fill = new ol.style.Fill({ color: getColorLive(floatvalue) });
	      let style = new ol.style.Style({ stroke: stroke, fill: fill, text: text }); 
	    return style;
    }

	  document.getElementById('export-png').addEventListener('click', function () {
	    map.once('rendercomplete', function () {
	      const mapCanvas = document.createElement('canvas');
	      const size = map.getSize();
		mapCanvas.width = size[0];
		mapCanvas.height = size[1];
		const mapContext = mapCanvas.getContext('2d');
		Array.prototype.forEach.call(
		      map.getViewport().querySelectorAll('.ol-layer canvas, canvas.ol-layer'),
		      function (canvas) {
		         if (canvas.width > 0) {
				const opacity =
			        canvas.parentNode.style.opacity || canvas.style.opacity;
				mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
				const backgroundColor = canvas.parentNode.style.backgroundColor;
				if (backgroundColor) {
				    mapContext.fillStyle = backgroundColor;
				    mapContext.fillRect(0, 0, canvas.width, canvas.height);
				  }
				let matrix;
				const transform = canvas.style.transform;
				if (transform) {
			        // Get the transform parameters from the style's transform matrix
			        matrix = transform
				.match(/^matrix\(([^\(]*)\)$/)[1]
			        .split(',')
			        .map(Number);
			} else {
			        matrix = [
			           parseFloat(canvas.style.width) / canvas.width,
				  0,
				  0,
				  parseFloat(canvas.style.height) / canvas.height,
				  0,
				  0,
				];
	  }
// Apply the transform to the export map context
CanvasRenderingContext2D.prototype.setTransform.apply(
			    mapContext,
		    matrix
		  );
mapContext.drawImage(canvas, 0, 0);
}
}
);
	    if (navigator.msSaveBlob) {
			  // link download attribute does not work on MS browsers
			  navigator.msSaveBlob(mapCanvas.msToBlob(), 'map.png');
			} else {
				      const link = document.getElementById('image-download');
				      link.href = mapCanvas.toDataURL();
				      link.click();
				    }
	  });
map.renderSync();
});

render_counties()
  </script>

</html>

